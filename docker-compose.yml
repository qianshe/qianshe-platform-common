# ==========================================================================
# Qianshe Platform Common åŸºç¡€è®¾æ–½æœåŠ¡é…ç½®
# ==========================================================================
# 
# ğŸ¯ ç®¡ç†ç­–ç•¥ï¼šåªç®¡ç†åŸºç¡€è®¾æ–½æœåŠ¡
# ğŸŒ ç½‘ç»œç­–ç•¥ï¼šç»Ÿä¸€ä½¿ç”¨ qianshe-network ç½‘ç»œ
# ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼šdocker-compose up -d
# 
# ğŸ“¦ åŒ…å«æœåŠ¡ï¼š
#   - gateway (ç½‘å…³æœåŠ¡)
#   - user-auth (è®¤è¯æœåŠ¡)
# 
# âš ï¸  æ³¨æ„ï¼šä¸šåŠ¡æœåŠ¡è¯·ä½¿ç”¨å¯¹åº”ä¸šåŠ¡é¡¹ç›®çš„é…ç½®å¯åŠ¨
# ==========================================================================

version: '3.8'

name: qianshe  # ä¸workspaceä¿æŒä¸€è‡´çš„é¡¹ç›®åç§°ï¼Œé¿å…å®¹å™¨åå†²çª

# å…¬å…±é…ç½®
x-app-env: &app-env
  SPRING_PROFILES_ACTIVE: test
  SPRING_CLOUD_NACOS_SERVER_ADDR: nacos-standalone-derby:8848
  SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR: nacos-standalone-derby:8848
  SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR: nacos-standalone-derby:8848
  # å‘½åç©ºé—´
  SPRING_CLOUD_NACOS_DISCOVERY_NAMESPACE: b84b598d-bbca-4fca-83fe-a1be6e34424b
  SPRING_CLOUD_NACOS_CONFIG_NAMESPACE: b84b598d-bbca-4fca-83fe-a1be6e34424b
  # é…ç½®ä¸­å¿ƒæ˜¯å¦å¯ç”¨
  SPRING_CLOUD_NACOS_CONFIG_ENABLED: true

x-db-config: &db-config
  SPRING_REDIS_HOST: redis
  SPRING_REDIS_PORT: 6379

services:
  # ========== åŸºç¡€è®¾æ–½æœåŠ¡ ==========
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    image: qianshe/gateway:latest
    container_name: gateway
    restart: unless-stopped
    ports:
      - "9000:9000"
    networks:
      - qianshe-network
    environment:
      <<: [*app-env, *db-config]

  user-auth:
    build:
      context: ./user-auth
      dockerfile: Dockerfile
    image: qianshe/user-auth:latest
    container_name: user-auth
    restart: unless-stopped
    networks:
      - qianshe-network
    environment:
      <<: [*app-env, *db-config]
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/qianshe_user?serverTimezone=Asia/Shanghai&useUnicode=true&characterEncoding=utf-8

# ç»Ÿä¸€ç½‘ç»œé…ç½®ï¼ˆä¸workspaceä¿æŒä¸€è‡´ï¼‰
networks:
  qianshe-network:
    external: true